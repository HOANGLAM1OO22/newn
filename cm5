Tuy·ªát v·ªùi üí™ ‚Äî gi·ªù ta ƒë·∫øn **Commit 5**, ph·∫ßn **cu·ªëi c√πng v√† ‚Äúƒë·ªânh‚Äù** c·ªßa b√†i *Video Rental Kata*:
th√™m **h√†m `htmlStatement()`**, ƒë·ªìng th·ªùi **refactor** ƒë·ªÉ lo·∫°i b·ªè tr√πng l·∫∑p gi·ªØa `statement()` v√† `htmlStatement()` b·∫±ng **Template Method Pattern** (m·∫´u m√† Martin Fowler s·ª≠ d·ª•ng trong s√°ch *Refactoring*).

---

## üéØ M·ª•c ti√™u Commit 5

> ‚úÖ Th√™m ch·ª©c nƒÉng in b√°o c√°o cho kh√°ch h√†ng d∆∞·ªõi d·∫°ng **HTML**
> ‚úÖ Lo·∫°i b·ªè tr√πng l·∫∑p gi·ªØa `statement()` v√† `htmlStatement()`
> ‚úÖ √Åp d·ª•ng **Template Method Pattern** ƒë·ªÉ ƒë·ªãnh nghƒ©a khung t·∫°o b√°o c√°o
> ‚úÖ T·∫•t c·∫£ test c≈© v·∫´n pass, th√™m test m·ªõi cho HTML output

---

## üí° √ù t∆∞·ªüng thi·∫øt k·∫ø

* T·∫°o abstract class `StatementFormatter` ƒë·ªãnh nghƒ©a **template method** `generate(Customer)`.
* C√°c subclass:

  * `TextStatement` ‚Üí format d·∫°ng vƒÉn b·∫£n
  * `HtmlStatement` ‚Üí format d·∫°ng HTML
* `Customer` ch·ªâ c√≤n 2 method ƒë∆°n gi·∫£n:

  ```java
  public String statement() { return new TextStatement().generate(this); }
  public String htmlStatement() { return new HtmlStatement().generate(this); }
  ```

---

## ‚úÖ Full Refactored Code ‚Äî Commit 5

### üß© StatementFormatter.java

```java
import java.util.Enumeration;

/**
 * Template Method Pattern:
 * Defines the structure for generating a rental statement.
 * Subclasses provide formatting details.
 */
public abstract class StatementFormatter {

    public String generate(Customer customer) {
        double totalAmount = 0;
        int frequentRenterPoints = 0;

        StringBuilder result = new StringBuilder();
        result.append(header(customer.getName()));

        Enumeration<Rental> rentals = customer.getRentals();
        while (rentals.hasMoreElements()) {
            Rental rental = rentals.nextElement();

            double thisAmount = rental.getCharge();
            frequentRenterPoints += rental.getFrequentRenterPoints();
            totalAmount += thisAmount;

            result.append(eachRental(rental.getMovie().getTitle(), thisAmount));
        }

        result.append(footer(totalAmount, frequentRenterPoints));
        return result.toString();
    }

    // Hook methods implemented by subclasses
    protected abstract String header(String customerName);
    protected abstract String eachRental(String title, double charge);
    protected abstract String footer(double totalAmount, int frequentRenterPoints);
}
```

---

### üßæ TextStatement.java

```java
public class TextStatement extends StatementFormatter {

    @Override
    protected String header(String customerName) {
        return "Rental Record for " + customerName + "\n";
    }

    @Override
    protected String eachRental(String title, double charge) {
        return "\t" + title + "\t" + charge + "\n";
    }

    @Override
    protected String footer(double totalAmount, int frequentRenterPoints) {
        return "Amount owed is " + totalAmount + "\n" +
               "You earned " + frequentRenterPoints + " frequent renter points";
    }
}
```

---

### üåê HtmlStatement.java

```java
public class HtmlStatement extends StatementFormatter {

    @Override
    protected String header(String customerName) {
        return "<h1>Rentals for <em>" + customerName + "</em></h1>\n<table>\n";
    }

    @Override
    protected String eachRental(String title, double charge) {
        return "<tr><td>" + title + "</td><td>" + charge + "</td></tr>\n";
    }

    @Override
    protected String footer(double totalAmount, int frequentRenterPoints) {
        return "</table>\n<p><b>Amount owed is <em>" + totalAmount + "</em></b></p>\n" +
               "<p><b>You earned <em>" + frequentRenterPoints + "</em> frequent renter points</b></p>\n";
    }
}
```

---

### üë§ Customer.java (refactored for Template Method)

```java
import java.util.Enumeration;
import java.util.Vector;

public class Customer {
    private final String name;
    private final Vector<Rental> rentals = new Vector<>();

    public Customer(String name) {
        this.name = name;
    }

    public void addRental(Rental rental) {
        rentals.add(rental);
    }

    public String getName() {
        return name;
    }

    // Expose rentals for the template method
    public Enumeration<Rental> getRentals() {
        return rentals.elements();
    }

    // Delegates formatting
    public String statement() {
        return new TextStatement().generate(this);
    }

    public String htmlStatement() {
        return new HtmlStatement().generate(this);
    }
}
```

---

### ‚úÖ CustomerTest.java (add HTML tests)

```java
import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

public class CustomerTest {

    @Test
    void testHtmlStatementForSingleRental() {
        Customer customer = new Customer("Emma");
        Movie movie = new Movie("Oppenheimer", Movie.NEW_RELEASE);
        customer.addRental(new Rental(movie, 2));

        String html = customer.htmlStatement();

        assertTrue(html.contains("<h1>Rentals for <em>Emma</em></h1>"));
        assertTrue(html.contains("<td>Oppenheimer</td><td>6.0</td>"));
        assertTrue(html.contains("Amount owed is"));
        assertTrue(html.contains("frequent renter points"));
    }

    @Test
    void testHtmlStatementWithMultipleRentals() {
        Customer customer = new Customer("John");
        customer.addRental(new Rental(new Movie("Frozen", Movie.CHILDREN), 3));
        customer.addRental(new Rental(new Movie("Top Gun", Movie.BEST_SELLER), 4));

        String html = customer.htmlStatement();

        assertTrue(html.contains("Frozen"));
        assertTrue(html.contains("Top Gun"));
        assertTrue(html.contains("<table>"));
        assertTrue(html.contains("</table>"));
        assertTrue(html.contains("Amount owed"));
        assertTrue(html.contains("frequent renter points"));
    }
}
```

---

### ‚ñ∂Ô∏è RentalManager.java (demo run)

```java
public class RentalManager {
    public static void main(String[] args) {
        Customer customer = new Customer("Hong");

        customer.addRental(new Rental(new Movie("Inception", Movie.REGULAR), 3));
        customer.addRental(new Rental(new Movie("Frozen", Movie.CHILDREN), 4));
        customer.addRental(new Rental(new Movie("Top Gun Maverick", Movie.BEST_SELLER), 3));

        System.out.println("----- TEXT STATEMENT -----");
        System.out.println(customer.statement());

        System.out.println("\n----- HTML STATEMENT -----");
        System.out.println(customer.htmlStatement());
    }
}
```

**Sample Output:**

```
----- TEXT STATEMENT -----
Rental Record for Hong
	Inception	3.5
	Frozen	3.0
	Top Gun Maverick	17.5
Amount owed is 24.0
You earned 16 frequent renter points

----- HTML STATEMENT -----
<h1>Rentals for <em>Hong</em></h1>
<table>
<tr><td>Inception</td><td>3.5</td></tr>
<tr><td>Frozen</td><td>3.0</td></tr>
<tr><td>Top Gun Maverick</td><td>17.5</td></tr>
</table>
<p><b>Amount owed is <em>24.0</em></b></p>
<p><b>You earned <em>16</em> frequent renter points</b></p>
```

---

## üßæ Commit message suggestion

```
feat: add htmlStatement() using Template Method pattern to remove duplication

- Introduced abstract StatementFormatter with template method generate()
- Added TextStatement and HtmlStatement for text and HTML formatting
- Simplified Customer by delegating statement generation
- Removed duplication between text and HTML output
- Added unit tests for HTML statement output
```

---

## üßπ Clean Code Principles in Commit 5

| Principle                       | Implementation                                                     |
| ------------------------------- | ------------------------------------------------------------------ |
| **DRY (Don‚Äôt Repeat Yourself)** | Shared logic moved into `StatementFormatter.generate()`            |
| **Template Method Pattern**     | Common statement generation algorithm with variable output formats |
| **OCP (Open/Closed)**           | Add new format (e.g., JSON) easily by subclassing                  |
| **SRP (Single Responsibility)** | Each formatter class has one clear concern                         |
| **Expressive Names**            | `eachRental()`, `footer()`, `header()` convey purpose clearly      |
| **Testability**                 | HTML output tested independently                                   |

---

## ‚úÖ K·∫øt qu·∫£ sau Commit 5

* `Customer` ho√†n to√†n s·∫°ch (ch·ªâ c√≥ 2 public methods)
* `statement()` v√† `htmlStatement()` kh√¥ng l·∫∑p code
* D·ªÖ m·ªü r·ªông th√™m ƒë·ªãnh d·∫°ng kh√°c (JSON, XML)
* T·∫•t c·∫£ test (Commit 1 ‚Üí 5) ƒë·ªÅu pass
* M√£ ngu·ªìn ƒë·∫°t chu·∫©n ‚Äú**Refactoring to Patterns**‚Äù üéØ

---

B·∫°n mu·ªën m√¨nh gi√∫p th√™m **t·ªïng h·ª£p l·∫°i full commit history (1 ‚Üí 5)** k√®m **PR description** ƒë·ªÉ b·∫°n push l√™n GitHub cho ƒë·∫πp (chu·∫©n tr√¨nh b√†y nh∆∞ m·ªôt mini-case study Clean Code)?
