Tuyá»‡t vá»i ğŸ˜ â€” giá» ta Ä‘áº¿n **Commit 5 (final refactor)** â€” báº£n hoÃ n chá»‰nh, **tÆ°Æ¡ng thÃ­ch vá»›i `PriceFactory`** vÃ  kiáº¿n trÃºc *Clean Code*.

ÄÃ¢y lÃ  phiÃªn báº£n Ä‘áº¡t â€œÄ‘á»‰nh Clean Architectureâ€ cho bÃ i **VideoRental Kata**, vá»›i:

âœ… Polymorphism (Price hierarchy)
âœ… Factory Pattern (`PriceFactory`)
âœ… Template Method Pattern (`StatementFormatter`)
âœ… TÃ¡ch package rÃµ rÃ ng, dá»… má»Ÿ rá»™ng (text, HTML, JSON, v.v.)
âœ… 100% Open/Closed, SRP, DIP compliance

---

## ğŸ¯ Má»¥c tiÃªu Commit 5

> * ThÃªm `htmlStatement()` theo **Template Method Pattern**
> * XÃ³a trÃ¹ng láº·p giá»¯a `statement()` vÃ  `htmlStatement()`
> * DÃ¹ng Factory (`PriceFactory`) trong há»‡ thá»‘ng
> * Giá»¯ má»i test (cÅ© & má»›i) pass

---

## ğŸ§© Cáº¥u trÃºc Package Chuáº©n

```
videorental/
 â”œâ”€â”€ customer/
 â”‚    â”œâ”€â”€ Customer.java
 â”‚    â””â”€â”€ statement/
 â”‚         â”œâ”€â”€ StatementFormatter.java
 â”‚         â”œâ”€â”€ TextStatement.java
 â”‚         â””â”€â”€ HtmlStatement.java
 â”œâ”€â”€ movie/
 â”‚    â”œâ”€â”€ Movie.java
 â”‚    â”œâ”€â”€ Price.java
 â”‚    â”œâ”€â”€ PriceFactory.java
 â”‚    â”œâ”€â”€ RegularPrice.java
 â”‚    â”œâ”€â”€ NewReleasePrice.java
 â”‚    â”œâ”€â”€ ChildrenPrice.java
 â”‚    â””â”€â”€ BestsellerPrice.java
 â”œâ”€â”€ rental/
 â”‚    â”œâ”€â”€ Rental.java
 â”‚    â””â”€â”€ RentalManager.java
 â””â”€â”€ test/
      â””â”€â”€ videorental/
           â””â”€â”€ CustomerTest.java
```

---

## âœ… Code chi tiáº¿t

### ğŸ§± `StatementFormatter.java`

```java
package videorental.customer.statement;

import java.util.Enumeration;
import videorental.customer.Customer;
import videorental.rental.Rental;

/**
 * Template Method Pattern:
 * Defines the common algorithm for generating statements.
 * Subclasses customize formatting.
 */
public abstract class StatementFormatter {

    public String generate(Customer customer) {
        double totalAmount = 0;
        int frequentRenterPoints = 0;
        StringBuilder result = new StringBuilder();

        result.append(header(customer.getName()));

        Enumeration<Rental> rentals = customer.getRentals();
        while (rentals.hasMoreElements()) {
            Rental rental = rentals.nextElement();

            double thisAmount = rental.getCharge();
            frequentRenterPoints += rental.getFrequentRenterPoints();
            totalAmount += thisAmount;

            result.append(eachRental(rental.getMovie().getTitle(), thisAmount));
        }

        result.append(footer(totalAmount, frequentRenterPoints));
        return result.toString();
    }

    protected abstract String header(String customerName);
    protected abstract String eachRental(String title, double charge);
    protected abstract String footer(double totalAmount, int frequentRenterPoints);
}
```

---

### ğŸ§¾ `TextStatement.java`

```java
package videorental.customer.statement;

/** Produces plain text version of rental statement. */
public class TextStatement extends StatementFormatter {

    @Override
    protected String header(String customerName) {
        return "Rental Record for " + customerName + "\n";
    }

    @Override
    protected String eachRental(String title, double charge) {
        return "\t" + title + "\t" + charge + "\n";
    }

    @Override
    protected String footer(double totalAmount, int frequentRenterPoints) {
        return "Amount owed is " + totalAmount + "\n" +
               "You earned " + frequentRenterPoints + " frequent renter points";
    }
}
```

---

### ğŸŒ `HtmlStatement.java`

```java
package videorental.customer.statement;

/** Produces HTML version of rental statement. */
public class HtmlStatement extends StatementFormatter {

    @Override
    protected String header(String customerName) {
        return "<h1>Rentals for <em>" + customerName + "</em></h1>\n<table>\n";
    }

    @Override
    protected String eachRental(String title, double charge) {
        return "<tr><td>" + title + "</td><td>" + charge + "</td></tr>\n";
    }

    @Override
    protected String footer(double totalAmount, int frequentRenterPoints) {
        return "</table>\n<p><b>Amount owed is <em>" + totalAmount + "</em></b></p>\n" +
               "<p><b>You earned <em>" + frequentRenterPoints +
               "</em> frequent renter points</b></p>\n";
    }
}
```

---

### ğŸ‘¤ `Customer.java`

```java
package videorental.customer;

import java.util.Enumeration;
import java.util.Vector;
import videorental.rental.Rental;
import videorental.customer.statement.TextStatement;
import videorental.customer.statement.HtmlStatement;

/**
 * Customer aggregates Rentals and delegates statement generation
 * to StatementFormatter subclasses.
 */
public class Customer {
    private final String name;
    private final Vector<Rental> rentals = new Vector<>();

    public Customer(String name) {
        this.name = name;
    }

    public void addRental(Rental rental) {
        rentals.add(rental);
    }

    public String getName() {
        return name;
    }

    public Enumeration<Rental> getRentals() {
        return rentals.elements();
    }

    public String statement() {
        return new TextStatement().generate(this);
    }

    public String htmlStatement() {
        return new HtmlStatement().generate(this);
    }
}
```

---

### ğŸŸ `Rental.java`

```java
package videorental.rental;

import videorental.movie.Movie;

/**
 * Rental represents a customer's rental of a specific movie.
 */
public class Rental {
    private final Movie movie;
    private final int daysRented;

    public Rental(Movie movie, int daysRented) {
        this.movie = movie;
        this.daysRented = daysRented;
    }

    public int getDaysRented() { return daysRented; }
    public Movie getMovie() { return movie; }

    public double getCharge() {
        return movie.getCharge(daysRented);
    }

    public int getFrequentRenterPoints() {
        return movie.getFrequentRenterPoints(daysRented);
    }
}
```

---

### ğŸ’° `Movie.java` (vá»›i `PriceFactory`)

```java
package videorental.movie;

public class Movie {
    public static final int REGULAR = 0;
    public static final int NEW_RELEASE = 1;
    public static final int CHILDREN = 2;
    public static final int BEST_SELLER = 3;

    private final String title;
    private Price price;

    public Movie(String title, int priceCode) {
        this.title = title;
        this.price = PriceFactory.create(priceCode);
    }

    public void setPriceCode(int priceCode) {
        this.price = PriceFactory.create(priceCode);
    }

    public String getTitle() { return title; }
    public double getCharge(int daysRented) { return price.getCharge(daysRented); }
    public int getFrequentRenterPoints(int daysRented) { return price.getFrequentRenterPoints(daysRented); }
}
```

---

### ğŸ­ `PriceFactory.java`

```java
package videorental.movie;

public class PriceFactory {

    private PriceFactory() {}

    public static Price create(int priceCode) {
        return switch (priceCode) {
            case Movie.REGULAR -> new RegularPrice();
            case Movie.NEW_RELEASE -> new NewReleasePrice();
            case Movie.CHILDREN -> new ChildrenPrice();
            case Movie.BEST_SELLER -> new BestsellerPrice();
            default -> throw new IllegalArgumentException("Unknown price code: " + priceCode);
        };
    }
}
```

---

### ğŸ’ `BestsellerPrice.java`

```java
package videorental.movie;

public class BestsellerPrice extends Price {

    @Override
    public int getPriceCode() {
        return Movie.BEST_SELLER;
    }

    @Override
    public double getCharge(int daysRented) {
        if (daysRented <= 2) {
            return daysRented * 5.0;
        } else {
            return (2 * 5.0) + (daysRented - 2) * 7.5;
        }
    }

    @Override
    public int getFrequentRenterPoints(int daysRented) {
        return daysRented * 5;
    }
}
```

---

### â–¶ï¸ `RentalManager.java` (demo)

```java
package videorental.rental;

import videorental.customer.Customer;
import videorental.movie.Movie;

public class RentalManager {
    public static void main(String[] args) {
        Customer customer = new Customer("Hong");

        customer.addRental(new Rental(new Movie("Inception", Movie.REGULAR), 3));
        customer.addRental(new Rental(new Movie("Oppenheimer", Movie.NEW_RELEASE), 2));
        customer.addRental(new Rental(new Movie("Top Gun Maverick", Movie.BEST_SELLER), 3));

        System.out.println("===== TEXT STATEMENT =====");
        System.out.println(customer.statement());

        System.out.println("\n===== HTML STATEMENT =====");
        System.out.println(customer.htmlStatement());
    }
}
```

---

### ğŸ§ª `CustomerTest.java` (kiá»ƒm tra cáº£ Text & HTML)

```java
import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;
import videorental.customer.Customer;
import videorental.movie.Movie;
import videorental.rental.Rental;

public class CustomerTest {

    @Test
    void testHtmlStatement() {
        Customer customer = new Customer("Emma");
        customer.addRental(new Rental(new Movie("Frozen", Movie.CHILDREN), 3));
        customer.addRental(new Rental(new Movie("Top Gun", Movie.BEST_SELLER), 4));

        String html = customer.htmlStatement();

        assertTrue(html.contains("<h1>Rentals for <em>Emma</em></h1>"));
        assertTrue(html.contains("<td>Frozen</td>"));
        assertTrue(html.contains("<td>Top Gun</td>"));
        assertTrue(html.contains("Amount owed"));
        assertTrue(html.contains("frequent renter points"));
    }

    @Test
    void testTextStatement() {
        Customer customer = new Customer("Liam");
        customer.addRental(new Rental(new Movie("Inception", Movie.REGULAR), 3));
        customer.addRental(new Rental(new Movie("Oppenheimer", Movie.NEW_RELEASE), 2));

        String statement = customer.statement();

        assertTrue(statement.contains("Rental Record for Liam"));
        assertTrue(statement.contains("Inception"));
        assertTrue(statement.contains("Oppenheimer"));
        assertTrue(statement.contains("Amount owed"));
        assertTrue(statement.contains("frequent renter points"));
    }
}
```

---

## ğŸ§¾ Commit message Ä‘á» xuáº¥t

```
feat: add htmlStatement() using Template Method pattern

- Introduced abstract StatementFormatter with template method generate()
- Added TextStatement and HtmlStatement subclasses for text and HTML output
- Customer delegates statement generation to formatter classes
- Removed duplication between text and HTML printing
- Compatible with existing PriceFactory architecture
- Added tests for HTML statement generation
```

---

## âœ… Káº¿t quáº£ sau Commit 5

| TiÃªu chÃ­                 | Káº¿t quáº£                                               |
| ------------------------ | ----------------------------------------------------- |
| Code duplication         | âŒ KhÃ´ng cÃ²n                                           |
| Movie type extensibility | âœ… ThÃªm loáº¡i má»›i chá»‰ cáº§n subclass + factory entry      |
| Output extensibility     | âœ… ThÃªm format má»›i chá»‰ cáº§n subclass StatementFormatter |
| Clean Architecture       | âœ… HoÃ n chá»‰nh (SRP, OCP, DIP)                          |
| Test coverage            | âœ… Full                                                |
| Output formats           | âœ… Text + HTML                                         |

---

Báº¡n cÃ³ muá»‘n mÃ¬nh lÃ m thÃªm bÆ°á»›c **â€œPR Summary / Final Reportâ€** (giá»‘ng mÃ´ táº£ PR trÃªn GitHub, liá»‡t kÃª má»¥c tiÃªu, káº¿t quáº£ tá»«ng commit 1â†’5, vÃ  biá»ƒu Ä‘á»“ phá»¥ thuá»™c class/package) Ä‘á»ƒ báº¡n gá»­i cho mentor/trÃ¬nh bÃ y trÆ°á»›c lá»›p khÃ´ng?
NÃ³ sáº½ giá»‘ng báº£n *Clean Code case study summary*.
