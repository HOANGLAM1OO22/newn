Tá»‘t láº¯m ğŸ‘
DÆ°á»›i Ä‘Ã¢y lÃ  **báº£n giáº£i thÃ­ch chi tiáº¿t vÃ  dá»… trÃ¬nh bÃ y trÆ°á»›c lá»›p** vá» pháº§n **Printer refactoring** trong bÃ i **SuperMarket TDD** â€” gá»“m **váº¥n Ä‘á» trÆ°á»›c**, **má»¥c tiÃªu refactor**, **giáº£i phÃ¡p Template Method**, **lá»£i Ã­ch**, vÃ  **cÃ¡ch test**.
MÃ¬nh viáº¿t theo phong cÃ¡ch báº¡n cÃ³ thá»ƒ **thuyáº¿t trÃ¬nh 3â€“5 phÃºt** trong lá»›p kÃ¨m slide ngáº¯n.

---

## ğŸ§© 1. Váº¥n Ä‘á» ban Ä‘áº§u

Lá»›p ban Ä‘áº§u lÃ :

```java
public class ReceiptPrinter {
    public String printReceipt(Receipt receipt) {
        // ...
    }
}
```

* NÃ³ **in hoÃ¡ Ä‘Æ¡n dáº¡ng text** (plain text) ra chuá»—i String.
* NhÆ°ng sau nÃ y yÃªu cáº§u má»›i:

  > â€œCáº§n thÃªm **HtmlPrinter** Ä‘á»ƒ in hoÃ¡ Ä‘Æ¡n ra dáº¡ng HTML cho web hoáº·c email.â€

Váº¥n Ä‘á» lÃ :

* Code in text vÃ  HTML **ráº¥t giá»‘ng nhau vá» cáº¥u trÃºc**:

  * Láº·p qua danh sÃ¡ch item â†’ in tá»«ng item
  * Láº·p qua discount â†’ in tá»«ng discount
  * Cuá»‘i cÃ¹ng in tá»•ng cá»™ng
* NhÆ°ng **khÃ¡c nhau á»Ÿ Ä‘á»‹nh dáº¡ng output** (text vs HTML).

Náº¿u ta copy toÃ n bá»™ logic tá»« `ReceiptPrinter` sang `HtmlReceiptPrinter`,
â†’ sáº½ cÃ³ **code trÃ¹ng láº·p ráº¥t lá»›n** vÃ  **khÃ³ báº£o trÃ¬**.
â†’ Náº¿u sau nÃ y thÃªm kiá»ƒu in khÃ¡c (PDF, JSON, CSV, â€¦), sáº½ pháº£i sá»­a á»Ÿ nhiá»u nÆ¡i.

---

## ğŸ¯ 2. Má»¥c tiÃªu refactoring

> **TÃ¡ch pháº§n â€œlogic chungâ€ vÃ  â€œÄ‘á»‹nh dáº¡ng cá»¥ thá»ƒâ€ ra riÃªng biá»‡t.**

Cá»¥ thá»ƒ:

* **Logic chung**: thá»© tá»± in (items â†’ discounts â†’ total)
* **Äá»‹nh dáº¡ng cá»¥ thá»ƒ**: cÃ¡ch trÃ¬nh bÃ y (text hay HTML)

Máº«u thiáº¿t káº¿ phÃ¹ há»£p cho Ä‘iá»u nÃ y chÃ­nh lÃ :

> ğŸ§  **Template Method Pattern**

---

## ğŸ§± 3. Ãp dá»¥ng Template Method Pattern

### âœ³ï¸ Táº¡o lá»›p trá»«u tÆ°á»£ng (template)

```java
public abstract class AbstractReceiptPrinter {
    public final String print(Receipt receipt) {
        StringBuilder out = new StringBuilder();
        begin(out);
        for (ReceiptItem item : receipt.getItems()) addItem(out, item);
        for (Discount d : receipt.getDiscounts()) addDiscount(out, d);
        addTotal(out, receipt);
        end(out);
        return out.toString();
    }

    // CÃ¡c bÆ°á»›c con (hook) sáº½ Ä‘Æ°á»£c subclass implement
    protected abstract void begin(StringBuilder out);
    protected abstract void addItem(StringBuilder out, ReceiptItem item);
    protected abstract void addDiscount(StringBuilder out, Discount discount);
    protected abstract void addTotal(StringBuilder out, Receipt receipt);
    protected abstract void end(StringBuilder out);
}
```

ğŸ”¹ `print()` lÃ  **template method** â€” nÃ³ cá»‘ Ä‘á»‹nh thá»© tá»± cÃ¡c bÆ°á»›c.
ğŸ”¹ CÃ¡c bÆ°á»›c con (`addItem`, `addDiscount`, â€¦) Ä‘Æ°á»£c **subclass override** Ä‘á»ƒ Ä‘á»‹nh nghÄ©a cÃ¡ch in cá»¥ thá»ƒ.

---

### ğŸ“ Triá»ƒn khai 1: TextReceiptPrinter

```java
public class TextReceiptPrinter extends AbstractReceiptPrinter {
    @Override
    protected void begin(StringBuilder out) {}

    @Override
    protected void addItem(StringBuilder out, ReceiptItem item) {
        out.append(item.getProduct().getName()).append(" ");
        out.append(String.format("%.2f", item.getTotalPrice())).append("\n");
    }

    @Override
    protected void addDiscount(StringBuilder out, Discount discount) {
        out.append(discount.getDescription()).append(" ");
        out.append(String.format("-%.2f", discount.getDiscountAmount())).append("\n");
    }

    @Override
    protected void addTotal(StringBuilder out, Receipt receipt) {
        out.append("Total: ").append(String.format("%.2f", receipt.getTotalPrice())).append("\n");
    }

    @Override
    protected void end(StringBuilder out) {}
}
```

ğŸŸ¢ **Chá»©c nÄƒng giá»‘ng ReceiptPrinter cÅ©**,
nhÆ°ng bÃ¢y giá» chá»‰ táº­p trung vÃ o **Ä‘á»‹nh dáº¡ng text**.

---

### ğŸ–¥ï¸ Triá»ƒn khai 2: HtmlReceiptPrinter

```java
public class HtmlReceiptPrinter extends AbstractReceiptPrinter {
    @Override
    protected void begin(StringBuilder out) {
        out.append("<html><body><table>");
    }

    @Override
    protected void addItem(StringBuilder out, ReceiptItem item) {
        out.append("<tr><td>")
           .append(item.getProduct().getName())
           .append("</td><td>")
           .append(String.format("%.2f", item.getTotalPrice()))
           .append("</td></tr>");
    }

    @Override
    protected void addDiscount(StringBuilder out, Discount discount) {
        out.append("<tr><td colspan='2'>")
           .append(discount.getDescription())
           .append(" (-").append(String.format("%.2f", discount.getDiscountAmount()))
           .append(")</td></tr>");
    }

    @Override
    protected void addTotal(StringBuilder out, Receipt receipt) {
        out.append("<tr><td>Total</td><td>")
           .append(String.format("%.2f", receipt.getTotalPrice()))
           .append("</td></tr>");
    }

    @Override
    protected void end(StringBuilder out) {
        out.append("</table></body></html>");
    }
}
```

ğŸŸ¢ Cáº¥u trÃºc giá»‘ng `TextReceiptPrinter`, nhÆ°ng Ä‘á»‹nh dáº¡ng HTML thay vÃ¬ text.

---

## ğŸ’¡ 4. Káº¿t quáº£ Ä‘áº¡t Ä‘Æ°á»£c

| TiÃªu chÃ­                 | TrÆ°á»›c khi refactor                        | Sau khi refactor                                       |
| ------------------------ | ----------------------------------------- | ------------------------------------------------------ |
| **Cáº¥u trÃºc**             | Táº¥t cáº£ logic & Ä‘á»‹nh dáº¡ng náº±m chung 1 lá»›p  | Logic chung tÃ¡ch ra lá»›p cha, Ä‘á»‹nh dáº¡ng riÃªng á»Ÿ lá»›p con |
| **Kháº£ nÄƒng má»Ÿ rá»™ng**     | ThÃªm Ä‘á»‹nh dáº¡ng má»›i pháº£i copy-paste        | Chá»‰ cáº§n táº¡o subclass má»›i vÃ  override 5 hÃ m             |
| **TrÃ¹ng láº·p code**       | Cao (in items, discounts, totals láº·p láº¡i) | Gáº§n nhÆ° khÃ´ng trÃ¹ng láº·p                                |
| **Báº£o trÃ¬**              | KhÃ³ chá»‰nh sá»­a náº¿u thÃªm feature má»›i        | Dá»… dÃ ng, chá»‰ cáº§n sá»­a logic chung 1 láº§n                 |
| **Máº«u thiáº¿t káº¿ sá»­ dá»¥ng** | âŒ None                                    | âœ… Template Method Pattern                              |

---

## ğŸ§ª 5. Kiá»ƒm thá»­

Ta viáº¿t test cho HTML printer:

```java
@Test
void renderHtmlWithItemsAndDiscounts() {
    Teller teller = new Teller(catalog);
    teller.addSpecialOffer(SpecialOfferType.ThreeForTwo, toothbrush, 0);
    Receipt receipt = teller.checksOutArticlesFrom(cart);

    HtmlReceiptPrinter printer = new HtmlReceiptPrinter();
    String html = printer.print(receipt);

    assertTrue(html.contains("<html>"));
    assertTrue(html.contains("toothbrush"));
    assertTrue(html.contains("Total"));
}
```

âœ… Káº¿t quáº£ test chá»©ng minh:
Cáº£ `TextReceiptPrinter` vÃ  `HtmlReceiptPrinter` Ä‘á»u in Ä‘Ãºng format nhÆ°ng dÃ¹ng chung quy trÃ¬nh in.

---

## ğŸ—£ï¸ 6. CÃ¡ch trÃ¬nh bÃ y (slide gá»£i Ã½)

**Slide 1: Problem**

> * Printer chá»‰ in Ä‘Æ°á»£c text
> * Muá»‘n thÃªm HTML â†’ pháº£i copy code
> * Code trÃ¹ng láº·p, khÃ³ má»Ÿ rá»™ng

**Slide 2: Goal**

> * Giá»¯ logic in hoÃ¡ Ä‘Æ¡n chung
> * Cho phÃ©p nhiá»u Ä‘á»‹nh dáº¡ng khÃ¡c nhau

**Slide 3: Solution â€“ Template Method Pattern**

> * `AbstractReceiptPrinter.print()` = template
> * Subclass (`Text`, `Html`) Ä‘á»‹nh nghÄ©a tá»«ng bÆ°á»›c nhá»

**Slide 4: Benefits**

> âœ… Dá»… má»Ÿ rá»™ng
> âœ… Giáº£m trÃ¹ng láº·p
> âœ… Cáº¥u trÃºc rÃµ rÃ ng hÆ¡n
> âœ… TuÃ¢n theo nguyÃªn táº¯c OCP (Openâ€“Closed Principle)

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n **táº¡o slide 4 trang ngáº¯n gá»n (PowerPoint hoáº·c PDF)** minh hoáº¡ báº±ng sÆ¡ Ä‘á»“ â€œTemplate Methodâ€ (base class + 2 subclass).
ğŸ‘‰ Báº¡n cÃ³ muá»‘n mÃ¬nh xuáº¥t slide trÃ¬nh bÃ y nÃ y khÃ´ng?
