Ráº¥t hay â€” Ä‘Ã¢y chÃ­nh lÃ  cÃ¢u há»i mÃ  má»™t **senior multimedia dev** thá»±c sá»± pháº£i há»i ğŸ‘
VÃ  **cÃ³**, hoÃ n toÃ n cÃ³ thá»ƒ xáº£y ra trong pipeline cá»§a báº¡n, tÃ¹y theo timing cá»§a thread pool (`transcode`/`transfer`) vÃ  cÃ¡ch gá»i `notifyComplete()` trong `MotionScrap`.

---

## ğŸ¯ PhÃ¢n tÃ­ch chi tiáº¿t

HÃ£y nhÃ¬n 2 nÆ¡i báº¡n Ä‘ang gá»i:

```kotlin
// (A) reportProgress()
onProgressListener?.onProgress(blended)

// (B) notifyComplete()
if (success) onProgressListener?.onProgress(1.0f)
```

VÃ  2 thread cháº¡y song song trong `executeTasks()`:

```kotlin
// Thread 1: transcodingTasks.forEach { videoTranscoder.process(it) ... }
// Thread 2: while(targetTaskId < numTasks) { videoTransfer.writeTrack(...) ... }
```

* Hai thread nÃ y cháº¡y **song song** trong cÃ¹ng `ExecutorService`.
* `notifyComplete(EXECUTE_COMPLETE)` Ä‘Æ°á»£c gá»i **bÃªn trong transfer-thread** khi task cuá»‘i cÃ¹ng xong (trong `executeTasks()`).
* Tuy nhiÃªn, `reportProgress()` Ä‘Æ°á»£c gá»i má»—i khi cÃ³ `onEachFrameTransferred` hoáº·c `onEachFrameTranscoded`.

âš ï¸ NhÆ°ng vÃ¬ `onEachFrameTransferred` Ä‘Æ°á»£c gá»­i qua **event callback** cá»§a `VideoTransfer` (khÃ¡c thread), vÃ  `notifyComplete` gá»i tháº³ng trong `executeTasks`,
thÃ¬ vá» máº·t thá»i gian, **`notifyComplete(EXECUTE_COMPLETE)` cÃ³ thá»ƒ cháº¡y trÆ°á»›c callback cuá»‘i cÃ¹ng cá»§a progress**, nháº¥t lÃ  khi encoder vá»«a flush xong frame cuá»‘i cÃ¹ng, transfer gá»i complete gáº§n nhÆ° ngay láº­p tá»©c.

---

## ğŸ” VÃ­ dá»¥ thá»±c táº¿

Log cÃ³ thá»ƒ xuáº¥t hiá»‡n nhÆ° sau:

```
[VideoTransfer] writeTrack last frame done
[MotionScrap] notifyComplete: EXECUTE_COMPLETE
[MotionScrap] onProgressListener -> 1.0f
[VideoTranscoder] onEachFrameTransferred (frame 954/954)
[MotionScrap] onProgressListener -> 0.999f
```

Káº¿t quáº£:
Progress vá» **0.999** **sau khi** complete â€” trÃ´ng nhÆ° â€œtá»¥t láº¡i 99.9% sau khi hoÃ n táº¥tâ€.

---

## ğŸ’¡ CÃ¡ch fix Ä‘Ãºng (synchronization-safe)

Giáº£i phÃ¡p lÃ  **Ä‘áº£m báº£o onProgress(1.0f) luÃ´n Ä‘Æ°á»£c phÃ¡t cuá»‘i cÃ¹ng**, vÃ  khÃ´ng thá»ƒ bá»‹ â€œghi Ä‘Ã¨â€ bá»Ÿi cÃ¡c progress cÅ© Ä‘áº¿n trá»….

### CÃ¡ch 1 â€” DÃ¹ng flag â€œisCompletedâ€

ThÃªm flag `isCompleted` Ä‘á»ƒ khÃ³a cÃ¡c update progress sau khi COMPLETE:

```kotlin
private val isCompleted = AtomicBoolean(false)

private fun reportProgress() {
    if (isCompleted.get()) return // âœ… skip progress update after complete

    val current = processedFrames.incrementAndGet()
    val progress = progressMeasureStrategy.onFrameProcessed(current)
    if (progress >= 0f) {
        val transcodingProgress = transcodingProgressTracker
            .runCatching {
                val (p, t) = report()
                if (t > 0) p.toFloat() / t else 0f
            }.getOrDefault(0f)

        val blended = (progress * 0.3f + transcodingProgress * 0.7f).coerceIn(0f, 0.999f)
        onProgressListener?.onProgress(blended)
    }
}

private fun notifyComplete(event: ExportEvent) {
    try {
        val success = event == ExportEvent.EXECUTE_COMPLETE
        SLog.i(TAG, "notifyComplete: $event, success=$success")

        if (success && isCompleted.compareAndSet(false, true)) {
            // âœ… Only send 1.0f once, and lock future updates
            onProgressListener?.onProgress(1.0f)
        }
        onCompleteListener?.invoke(success, event)
    } catch (e: Exception) {
        SLog.e(TAG, "onCompleteListener failed: $e")
    }
}
```

### Æ¯u Ä‘iá»ƒm

* Äáº£m báº£o **progress khÃ´ng bao giá» giáº£m sau 100%**
* KhÃ´ng cáº§n Ä‘á»“ng bá»™ thread phá»©c táº¡p
* Váº«n thread-safe vÃ¬ dÃ¹ng `AtomicBoolean`

---

### CÃ¡ch 2 â€” Gá»™p xá»­ lÃ½ trong Main/UI thread

Náº¿u báº¡n cÃ³ `Handler` hoáº·c `Executor` UI chÃ­nh (vÃ­ dá»¥ tá»« `Handler(Looper.getMainLooper())`),
hÃ£y post má»i progress/complete vá» cÃ¹ng thread Ä‘á»ƒ Ä‘áº£m báº£o thá»© tá»± tuyá»‡t Ä‘á»‘i:

```kotlin
mainHandler.post {
    onProgressListener?.onProgress(1.0f)
}
```

NhÆ°ng trong code hiá»‡n táº¡i báº¡n khÃ´ng tháº¥y UI thread handle, nÃªn **CÃ¡ch 1** lÃ  tá»‘i Æ°u nháº¥t.

---

## âœ… Káº¿t luáº­n

**CÃ³ thá»ƒ xáº£y ra** tÃ¬nh huá»‘ng `notifyComplete()` Ä‘áº¿n trÆ°á»›c `onProgress(1f)` â†’ dáº«n Ä‘áº¿n tá»¥t progress.
**CÃ¡ch fix chÃ­nh xÃ¡c:**

* ThÃªm `AtomicBoolean isCompleted`
* Trong `reportProgress()`: bá» qua náº¿u Ä‘Ã£ complete
* Trong `notifyComplete()`: set flag vÃ  emit `1.0f` Ä‘Ãºng 1 láº§n.

---

Báº¡n cÃ³ muá»‘n tÃ´i chÃ¨n Ä‘áº§y Ä‘á»§ Ä‘oáº¡n code hoÃ n chá»‰nh Ä‘Ã£ fix pháº§n nÃ y (AtomicBoolean + comment giáº£i thÃ­ch) vÃ o file `MotionScrap.kt` khÃ´ng?
TÃ´i cÃ³ thá»ƒ Ä‘Æ°a nguyÃªn block Ä‘Ã£ tinh chá»‰nh sáºµn.
